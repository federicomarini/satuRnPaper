---
title: "Hsapiens_lengthBias"
output: html_document
---

Length bias analysis for the count dataset

```{r}
library(grid)
library(gridExtra)
library(ggplot2)
library(rtracklayer)
library(IsoformSwitchAnalyzeR)
```

```{r}
#load(file='01_Hsapiens_benchmark_data_count.Rdata')
load(file='01_Hsapiens_benchmark_data_scaledTPM.Rdata')

metaInfo <- c(HsBenchmarkLenient,HsBenchmarkStringent)

HsBenchmarkLenient <- list(HsBenchmarkLenient)
HsBenchmarkStringent <- list(HsBenchmarkStringent)

### Combine
names(HsBenchmarkLenient)   <- paste0(names(HsBenchmarkLenient)  , 'filterLenient')
names(HsBenchmarkStringent) <- paste0(names(HsBenchmarkStringent), 'filterStringent')

metaInfo <- c(
    HsBenchmarkLenient,
    HsBenchmarkStringent
)

#load('02_Hsapiens_benchmark_DTU_analysis_count.Rdata')
load('02_Hsapiens_benchmark_DTU_analysis_scaledTPM.Rdata')
    
HsBenchmark_count <- c(
   HsDtuBenchmark_DEXSeq,
   HsDtuBenchmark_DoubleExpSeq,
   HsDtuBenchmark_DRIMSeq,
   HsDtuBenchmark_edgeRdiffsplice,
   HsDtuBenchmark_limmaDiffsplice,
   HsDtuBenchmark_NBSplice,
   HsDtuBenchmark_quasiBinomial)

HsBenchmark_count  <- HsBenchmark_count[which(
        sapply(HsBenchmark_count, function(x) ! is.null(x$dtuAnalysis))
)]

rm(HsBenchmarkLenient,
   HsBenchmarkStringent,
   HsDtuBenchmark_DEXSeq,
   HsDtuBenchmark_DRIMSeq,
   HsDtuBenchmark_DoubleExpSeq,
   HsDtuBenchmark_edgeRdiffsplice,
   HsDtuBenchmark_limmaDiffsplice,
   HsDtuBenchmark_NBSplice,
   HsDtuBenchmark_quasiBinomial)
gc()
```

Get isoform length information (human)

```{r}
gtf_h <- rtracklayer::import("/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Data/Hsapiens_data/Homo_sapiens.GRCh37.71.gtf")
gtf_h <- gtf_h[which(gtf_h$type == 'exon'),]

isoformLengths <- sapply(
    X = split(
        x = gtf_h@ranges@width,
        f = gtf_h$transcript_id
    ),
    FUN = sum
)

txs_len <- isoformLengths
names(txs_len) <- sub("\\..*", "", names(isoformLengths))
```

Compute transcript length bias for each method in each dataset

```{r}
resList <- list()

# loop over datasets
for (current_dataset in names(metaInfo)) {
  
  # select current dataset
  HsBenchmark_count_current <- HsBenchmark_count[grepl(current_dataset,names(HsBenchmark_count))]
  metaInfo_current <- metaInfo[grepl(current_dataset,names(metaInfo))]
  
  # select transcripts in current dataset
  txs_len_current <- txs_len[which(names(txs_len) %in% sub("\\..*", "", metaInfo_current[[1]]$metaInfo$TXNAME))]
  txs_len_current <- txs_len_current[unique(names(txs_len_current))]
  
  # define "long" trascript as longer than median
  long <- ifelse(txs_len_current>median(txs_len_current),"yes","no")
  
  # For DoubleExpSeq and NBSplice, FDRs must still be calculated
  HsBenchmark_count_current[[2]]$dtuAnalysis$FDR <- p.adjust(HsBenchmark_count_current[[2]]$dtuAnalysis$p_value, method = "BH")
  HsBenchmark_count_current[[6]]$dtuAnalysis$FDR <- p.adjust(HsBenchmark_count_current[[6]]$dtuAnalysis$p_value, method = "BH")

  # get results for each of the methods
  ### start getting result
  stats <- c()
  pvalues <- c()
  
  for (i in 1:length(HsBenchmark_count_current)) {

      method_result <- ifelse(HsBenchmark_count_current[[i]]$dtuAnalysis$FDR <= 0.05, "yes", "no")
      names(method_result) <- sub("\\..*", "", HsBenchmark_count_current[[i]]$dtuAnalysis$TXNAME)
      
      method_result <- method_result[match(names(long),names(method_result))]
      
      method_test <- fisher.test(table(long,method_result))
      stats <- c(stats,method_test$estimate)
      pvalues <- c(pvalues,method_test$p.value)

  }
  
  # wrangle results
  methods <- c("DEXSeq","DoubleExpSeq","DRIMSeq","edgeR_diffsplice","limma_diffsplice","NBSplice","qbDTU")
  
  current_result <- data.frame(cbind(methods,stats,pvalues))
  colnames(current_result) <- c("method","stats","pvalues")

  current_result$method <- as.factor(current_result$method)
  current_result$stats <- as.numeric(current_result$stats)
  current_result$pvalues <- as.numeric(current_result$pvalues)
  rownames(current_result) <- 1:nrow(current_result)
  
  # save result in list
  resList[[current_dataset]] <- current_result
}
```

Plot performances

```{r}
analyses <- c("filterLenient","filterStringent")

plotList <- list()

for (analysis in analyses) {
  
  current_analysis <- resList[grepl(analysis,names(resList))]

  gg <- ggplot(data = current_analysis[[1]],mapping=aes(x=stats,y=method,color=ifelse(pvalues<0.05, "red", "black"))) +
      scale_color_identity() +
      geom_point() +
      theme_bw() +
      ggtitle(analysis)
  
  plotList[[analysis]] <- gg
}
png("/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Results/Hsapiens_benchmark/plot_scaledTPM_lengthBias.png",
    width     = 8,
    height    = 5,
    units     = "in",
    res       = 200,
    pointsize = 4) # start export
do.call(grid.arrange, c(plotList, ncol=3))
dev.off()
```
