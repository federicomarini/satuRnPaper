---
title: "Hsapiens_visualize"
output: html_document
---

```{r,message=FALSE}
library(tidyverse)
library(iCOBRA)
```

Load data

```{r}
if(TRUE) {
    load(file='01_Hsapiens_benchmark_data_count.Rdata')
    load(file='02_Hsapiens_benchmark_DTU_analysis_count.Rdata')
    
    #load(file='01_Hsapiens_benchmark_data_scaledTPM.Rdata')
    #load(file='02_Hsapiens_benchmark_DTU_analysis_scaledTPM.Rdata')
  
    HsapiensBenchmark <- c(
        HsDtuBenchmark_quasiBinomial,
        HsDtuBenchmark_limmaDiffsplice,
        HsDtuBenchmark_DEXSeq,
        HsDtuBenchmark_DRIMSeq,
        HsDtuBenchmark_edgeRdiffsplice,
        HsDtuBenchmark_NBSplice,
        HsDtuBenchmark_DoubleExpSeq
    )

    HsapiensBenchmark  <- HsapiensBenchmark[which(
        sapply(HsapiensBenchmark, function(x) ! is.null(x$dtuAnalysis))
    )]
    
    rm(HsDtuBenchmark_quasiBinomial,
        HsDtuBenchmark_limmaDiffsplice,
        HsDtuBenchmark_DEXSeq,
        HsDtuBenchmark_DRIMSeq,
        HsDtuBenchmark_edgeRdiffsplice,
        HsDtuBenchmark_NBSplice,
        HsDtuBenchmark_DoubleExpSeq)
    invisible(gc())
}

truth_file <- read.table("/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Data/Hsapiens_data/3_truth/truth_Hsapiens.txt",header = TRUE)
```

```{r}
get_pvalues <- function(dataset,nmethods) {
  
  pvalues <- matrix(data=NA, nrow=nrow(dataset[[1]]$dtuAnalysis), ncol=nmethods)
  rownames(pvalues) <- dataset[[1]]$dtuAnalysis$TXNAME
  
  for (i in 1:nmethods) {
    pvalues_new <- data.frame(dataset[[i]]$dtuAnalysis$p_value)
    rownames(pvalues_new) <- dataset[[i]]$dtuAnalysis$TXNAME
    colnames(pvalues_new) <- names(dataset)[i]

    pvalues[,i] <- pvalues_new[match(rownames(pvalues),rownames(pvalues_new)),1]
  }
  
  pvalues <- apply(pvalues, 2, as.numeric)
  rownames(pvalues) <- dataset[[1]]$dtuAnalysis$TXNAME
  pvalues <- as.data.frame(pvalues)
  pvalues <- pvalues[order(rownames(pvalues)),]
  
  colnames(pvalues) <- c("quasiBinomial", "limma_diffsplice", "DEXSeq","DRIMSeq", "edgeR_diffsplice", "NBSplice", "DoubleExpSeq")
  
  return(pvalues)
}
```


```{r}
visualize_datasets <- function(dataset,nFilters,nmethods) {
  
  print(paste("This function will generate", nFilters, "plots"))

##  We must select the correct dataframes from the list, based on the list names
selection <- c("filterLenient","filterStringent")

## Generate and store the data for the plots
  resList <- c()
  for (j in 1:nFilters) {
      print(j) # print progress
  
      Hsapiens_current <- HsapiensBenchmark[grepl(selection[j], names(HsapiensBenchmark))]
      
      pvalues <- get_pvalues(Hsapiens_current,nmethods)
      
      truth_file_current <- truth_file[truth_file$transcript_id %in% rownames(pvalues),]
      truth_file_current <- truth_file_current[order(truth_file_current$transcript_id),]
      rownames(truth_file_current) <- truth_file_current$transcript_id

      cobra <- COBRAData(pval = pvalues, truth = truth_file_current)
      cobra <- calculate_adjp(cobra)
      cobra1perf <- calculate_performance(cobra, binary_truth = "transcript_ds_status", cont_truth = "none", splv = "none", aspects = c("fdrtpr", "fdrtprcurve", "overlap"))

      cobraplot <- prepare_data_for_plot(cobra1perf, colorscheme = "Dark2", facetted = TRUE)
      
      # DRIMSeq 
      new_col <- c(rep(c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "black", "#999999"),4),rep("white",16))
      names(new_col) <- names(cobraplot@plotcolors)
      cobraplot@plotcolors <- new_col
      
      plot_full <- plot_fdrtprcurve(cobraplot, xaxisrange = c(0, 0.35), yaxisrange = c(0,0.85))
    
      titles <- c("5 versus 5 - edgeR filter","5 versus 5 - DRIMSeq filter")
      current_title <- titles[j]

      plot_full <- plot_full + 
        ggtitle(current_title) +
        theme(strip.background = element_blank(),
            strip.text.x = element_blank(),
            plot.title = element_text(size=10),
            axis.text.x = element_text(size = 10),
            axis.text.y = element_text(size = 10),
            axis.title.x = element_text(size = 10),
            axis.title.y = element_text(size = 10))
      
      # png(paste("/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Results/Hsapiens_benchmark/plot_icobra_tpm_", selection[j], ".png", sep = ""),
      #     width     = 5.5,
      #     height    = 4.5,
      #     units     = "in",
      #     res       = 200,
      #     pointsize = 4) # start export
      print(plot_full)
      # dev.off()
  }
  
}
```

```{r}
visualize_datasets(dataset=HsapiensBenchmark,nFilters=2,nmethods=7)
```








