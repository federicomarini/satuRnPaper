#saveRDS(sumExp, "sumExp.Rds")
sumExp <- readRDS(file = "/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Case_study_L5It/sumExp.Rds")
DTU_tx <-  rownames(rowData(sumExp)[[5+3]][rowData(sumExp)[[5+3]]$empirical_FDR <= 0.05 & !is.na(rowData(sumExp)[[5+3]]$estimates),])
## for data import
library(AnnotationHub)
library(ensembldb)
library(openxlsx)
## for analysis
library(qbDTU)
library(edgeR)
library(tidyverse)
library(SummarizedExperiment)
## for visualization
library(ggplot2)
DTU_tx <-  rownames(rowData(sumExp)[[5+3]][rowData(sumExp)[[5+3]]$empirical_FDR <= 0.05 & !is.na(rowData(sumExp)[[5+3]]$estimates),])
DTU_gene <- tx2gene[which(tx2gene$TXNAME %in% DTU_tx), "GENEID"]
## Load the annotation resource.
ah <- AnnotationHub()
## Query for all available EnsDb databases
all <- query(ah, "EnsDb")
ahEdb <- all[["AH75036"]] #for Mus musculus
txs <- transcripts(ahEdb)
tx2gene <- as.data.frame(matrix(data = NA, nrow = length(txs), ncol = 2))
colnames(tx2gene) <- c("TXNAME","GENEID")
tx2gene$TXNAME <- txs$tx_id
tx2gene$GENEID <- txs$gene_id
DTU_tx <-  rownames(rowData(sumExp)[[5+3]][rowData(sumExp)[[5+3]]$empirical_FDR <= 0.05 & !is.na(rowData(sumExp)[[5+3]]$estimates),])
DTU_gene <- tx2gene[which(tx2gene$TXNAME %in% DTU_tx), "GENEID"]
sink(file = "GSEA/Tasic_L5IT_contrast5_DTU_satuRn.txt")
cat(DTU_gene, "\n")
sink()
DTU_tx <-  rownames(rowData(sumExp)[[6+3]][rowData(sumExp)[[6+3]]$empirical_FDR <= 0.05 & !is.na(rowData(sumExp)[[6+3]]$estimates),])
DTU_gene <- tx2gene[which(tx2gene$TXNAME %in% DTU_tx), "GENEID"]
sink(file = "GSEA/Tasic_L5IT_contrast6_DTU_satuRn.txt")
cat(DTU_gene, "\n")
sink()
DTU_tx <-  rownames(rowData(sumExp)[[7+3]][rowData(sumExp)[[7+3]]$empirical_FDR <= 0.05 & !is.na(rowData(sumExp)[[7+3]]$estimates),])
DTU_gene <- tx2gene[which(tx2gene$TXNAME %in% DTU_tx), "GENEID"]
sink(file = "GSEA/Tasic_L5IT_contrast7_DTU_satuRn.txt")
cat(DTU_gene, "\n")
sink()
rm(list=ls())
gc()
library(SummarizedExperiment)
library(qbDTU)
library(ggplot2)
library(tidyverse)
sumExp <- readRDS(file="/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Case_study_L5It/sumExp.Rds")
limmaRes_all <- readRDS(file="/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Case_study_L5It/limmaRes_all.Rds")
load("/Users/jg/Desktop/PhD/DTU_project/Github/dtuPaper/Case_study_L5It/topTreat_DGE.Rda")
txInfo <- as.data.frame(rowData(sumExp)[,c(1,2)])
txInfo$rank_limma <- match(txInfo$isoform_id,rownames(limmaRes_all[[6]]))
txInfo$rank_qbDTU <- match(txInfo$isoform_id,rownames(rowData(sumExp)[["fitQBResult_C6"]])[order(rowData(sumExp)[["fitQBResult_C6"]]$empirical_pval)])
txInfo$diffRank <- abs(txInfo$rank_limma - txInfo$rank_qbDTU) # difference in ranks between both methods
totalCount <- qbDTU:::getTotalCount(assay(sumExp), txInfo)
mean_tot <- rowMeans(totalCount) # summarize gene-level counts as the mean over all cells
qbDTU_DTU <- rowData(sumExp)[["fitQBResult_C6"]]$empirical_FDR # DTU in qbDTU
names(qbDTU_DTU) <- rownames(rowData(sumExp)[["fitQBResult_C6"]])
limma_DTU <- limmaRes_all[[6]]$empirical_FDR # DTU in limma
names(limma_DTU) <- rownames(limmaRes_all[[6]])
limma_DTU <- limma_DTU[match(names(qbDTU_DTU),names(limma_DTU))]
both <- qbDTU_DTU<0.05 & limma_DTU<0.05 # DTU in both
qbDTU <- qbDTU_DTU<0.05 & !limma_DTU<0.05 # DTU in qbDTU only
limma <- limma_DTU<0.05 & !qbDTU_DTU<0.05 # DTU in limma only
DTU_all <- limma
DTU_all[which(DTU_all==TRUE)] <- "limmaDiffsplice"
DTU_all[which(qbDTU==TRUE)] <- "satuRn"
DTU_all[which(both==TRUE)] <- "both"
DTU_all[which(DTU_all==FALSE)] <- "none"
gg_data <- as.data.frame(cbind(names(DTU_all),unname(DTU_all),mean_tot))
colnames(gg_data) <- c("transcript","method","totalCount")
gg_data$method <- as.factor(gg_data$method)
gg_data$totalCount <- as.numeric(gg_data$totalCount)
# png("CaseStudy_results/totalCount.png",
#   width     = 5,
#   height    = 5,
#   units     = "in",
#   res       = 200,
#   pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("grey84","#0072B2","black"))
# dev.off()
# png("CaseStudy_results/totalCount.png",
#   width     = 5,
#   height    = 5,
#   units     = "in",
#   res       = 200,
#   pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("grey84","#0072B2","black"))
# dev.off()
gg_data$method <- factor(gg_data$method, levels = c("satuRn","both","limmaDiffsplice","none"))
# png("CaseStudy_results/totalCount.png",
#   width     = 5,
#   height    = 5,
#   units     = "in",
#   res       = 200,
#   pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("grey84","#0072B2","black"))
# dev.off()
# png("CaseStudy_results/totalCount.png",
#   width     = 5,
#   height    = 5,
#   units     = "in",
#   res       = 200,
#   pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2"))
# dev.off()
# png("CaseStudy_results/totalCount.png",
#   width     = 5,
#   height    = 5,
#   units     = "in",
#   res       = 200,
#   pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2"))
# dev.off()
# png("CaseStudy_results/totalCount.png",
#   width     = 5,
#   height    = 5,
#   units     = "in",
#   res       = 200,
#   pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
# dev.off()
png("CaseStudy_results/totalCount.png",
width     = 5,
height    = 5,
units     = "in",
res       = 200,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
getwd()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 5,
height    = 5,
units     = "in",
res       = 200,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 5,
height    = 4,
units     = "in",
res       = 200,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4,
height    = 3,
units     = "in",
res       = 200,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4,
height    = 3,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
dim(totalCount)
quant_sf_current <- quant_sf[,sumExp$group %in% c("VISp.L5_IT_VISp_Hsd11b1_Endou", "ALM.L5_IT_ALM_Tnc")] # get only cells from contrast 6
quant_sf_current <- assay(sumExp)[,sumExp$group %in% c("VISp.L5_IT_VISp_Hsd11b1_Endou", "ALM.L5_IT_ALM_Tnc")] # get only cells from contrast 6
totalCount <- qbDTU:::getTotalCount(quant_sf_current, txInfo)
dim(totalCount)
totalCount <- qbDTU:::getTotalCount(quant_sf_current, txInfo)
mean_tot <- rowMeans(totalCount) # summarize gene-level counts as the mean over all cells
frac_zero <- rowSums(quant_sf_current == 0)/ncol(quant_sf_current)
qbDTU_DTU <- rowData(sumExp)[["fitQBResult_C6"]]$empirical_FDR # DTU in qbDTU
names(qbDTU_DTU) <- rownames(rowData(sumExp)[["fitQBResult_C6"]])
limma_DTU <- limmaRes_all[[6]]$empirical_FDR # DTU in limma
names(limma_DTU) <- rownames(limmaRes_all[[6]])
limma_DTU <- limma_DTU[match(names(qbDTU_DTU),names(limma_DTU))]
both <- qbDTU_DTU<0.05 & limma_DTU<0.05 # DTU in both
qbDTU <- qbDTU_DTU<0.05 & !limma_DTU<0.05 # DTU in qbDTU only
limma <- limma_DTU<0.05 & !qbDTU_DTU<0.05 # DTU in limma only
DTU_all <- limma
DTU_all[which(DTU_all==TRUE)] <- "limmaDiffsplice"
DTU_all[which(qbDTU==TRUE)] <- "satuRn"
DTU_all[which(both==TRUE)] <- "both"
DTU_all[which(DTU_all==FALSE)] <- "none"
gg_data <- as.data.frame(cbind(names(DTU_all),unname(DTU_all),mean_tot,frac_zero))
colnames(gg_data) <- c("transcript","method","totalCount")
gg_data$method <- as.factor(gg_data$method)
gg_data$totalCount <- as.numeric(gg_data$totalCount)
gg_data$frac_zero <- as.numeric(gg_data$frac_zero)
DTU_all <- limma
DTU_all[which(DTU_all==TRUE)] <- "limmaDiffsplice"
DTU_all[which(qbDTU==TRUE)] <- "satuRn"
DTU_all[which(both==TRUE)] <- "both"
DTU_all[which(DTU_all==FALSE)] <- "none"
gg_data <- as.data.frame(cbind(names(DTU_all),unname(DTU_all),mean_tot,frac_zero))
colnames(gg_data) <- c("transcript","method","totalCount","frac_zero")
gg_data$method <- as.factor(gg_data$method)
gg_data$totalCount <- as.numeric(gg_data$totalCount)
gg_data$frac_zero <- as.numeric(gg_data$frac_zero)
gg_data$method <- factor(gg_data$method, levels = c("satuRn","both","limmaDiffsplice","none"))
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4,
height    = 3,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4,
height    = 3,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count")
dev.off()
gg_data$frac_non_zero <- 1-gg_data$frac_zero
gg_data$frac_non_zero <- 1-gg_data$frac_zero
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=frac_non_zero,fill=method)) +
geom_violin() +
geom_jitter(aes(colour=method),width = 0.1) +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
scale_color_manual(values=c("grey60","black","black")) +
ylim(0,1) +
ggtitle("Fraction of zeros in DTU transcripts") +
stat_summary(fun.y=median, geom="point", shape=18, size=5, col="darkgreen")
gg_data$frac_non_zero <- 1-gg_data$frac_zero
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/frac_nonZero.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=frac_non_zero,fill=method)) +
geom_violin() +
geom_jitter(aes(colour=method),width = 0.1) +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
scale_color_manual(values=c("grey60","black","black")) +
ylim(0,1) +
ggtitle("Fraction of non-zeros in DTU transcripts") +
stat_summary(fun.y=median, geom="point", shape=18, size=5, col="darkgreen")
dev.off()
gg_data$frac_non_zero <- 1-gg_data$frac_zero
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/frac_nonZero.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=frac_non_zero,fill=method)) +
geom_violin() +
geom_jitter(aes(colour=method),width = 0.1) +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
scale_color_manual(values=c("grey60","black","black")) +
ylim(0,1) +
ggtitle("Fraction of non-zeros in DTU transcripts") +
stat_summary(fun=median, geom="point", shape=18, size=5, col="darkgreen")
dev.off()
gg_data$frac_non_zero <- 1-gg_data$frac_zero
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/frac_nonZero.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=frac_non_zero,fill=method)) +
geom_violin() +
geom_jitter(aes(colour=method),width = 0.1) +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
scale_color_manual(values=c("grey60","black","black")) +
ylim(0,1) +
ggtitle("Fraction of non-zeros in DTU transcripts") +
stat_summary(fun=median, geom="point", shape=18, size=5, col="darkgreen") +
ylab("fraction_non_zero")
dev.off()
gg_data$frac_non_zero <- 1-gg_data$frac_zero
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/frac_nonZero.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=frac_non_zero,fill=method)) +
geom_violin() +
geom_jitter(aes(colour=method),width = 0.1) +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
scale_color_manual(values=c("grey60","black","black")) +
ylim(0,1) +
ggtitle("Fraction of non-zero counts in DTU transcripts") +
stat_summary(fun=median, geom="point", shape=18, size=5, col="darkgreen") +
ylab("fraction_non_zero")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count") +
ggtitle("Average gene-level counts of DTU transcripts") +
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count") +
ggtitle("Average gene-level counts of DTU transcripts")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count") +
ggtitle("Average gene-level counts of DTU transcripts")
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count") +
ggtitle("Average gene-level counts of DTU transcripts") +
theme(plot.title = element_text(size = 12))
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count") +
ggtitle("Average gene-level counts of DTU transcripts") +
theme(plot.title = element_text(size = 8))
dev.off()
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/totalCount.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=totalCount,fill=method)) +
geom_boxplot() +
scale_y_log10() +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
ylab("gene-level count") +
ggtitle("Average gene-level counts of DTU transcripts") +
theme(plot.title = element_text(size = 10))
dev.off()
gg_data$frac_non_zero <- 1-gg_data$frac_zero
png("/Users/jg/Desktop/PhD/DTU_project/DTU_paper/Results/CaseStudy/frac_nonZero.png",
width     = 4.5,
height    = 3.5,
units     = "in",
res       = 400,
pointsize = 4)
ggplot(data = gg_data[-which(gg_data$method == "none"),], aes(x=method,y=frac_non_zero,fill=method)) +
geom_violin() +
geom_jitter(aes(colour=method),width = 0.1) +
theme_classic() +
scale_fill_manual(values=c("black","grey84","#0072B2")) +
scale_color_manual(values=c("grey60","black","black")) +
ylim(0,1) +
ggtitle("Fraction of non-zero counts in DTU transcripts") +
stat_summary(fun=median, geom="point", shape=18, size=5, col="darkgreen") +
ylab("fraction_non_zero")  +
theme(plot.title = element_text(size = 10))
dev.off()
rm(list=ls())
gc()
